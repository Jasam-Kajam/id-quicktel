<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gas Hub Marketplace</title>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";
  import { 
    getAuth, signOut, onAuthStateChanged, 
    GoogleAuthProvider, FacebookAuthProvider, signInWithPopup 
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBHxLJOZ5bdApAhSKOn2v9GtgrbsIxK_6A",
    authDomain: "gashub-917f2.firebaseapp.com",
    projectId: "gashub-917f2",
    storageBucket: "gashub-917f2.firebasestorage.app",
    messagingSenderId: "738809329471",
    appId: "1:738809329471:web:8cde88a1ee187b1971c58a",
    measurementId: "G-V0VZHX3JBF"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  window.auth = auth;
  window.db = db;
  window.storage = storage;

  const googleProvider = new GoogleAuthProvider();
  const facebookProvider = new FacebookAuthProvider();

  // Social login functions
  window.googleLogin = async function() {
    try {
      const result = await signInWithPopup(auth, googleProvider);
      const user = result.user;
      window.setupUser(user);
      alert("Logged in with Google: " + user.displayName);
    } catch(err) { alert(err.message); }
  }

  window.facebookLogin = async function() {
    try {
      const result = await signInWithPopup(auth, facebookProvider);
      const user = result.user;
      window.setupUser(user);
      alert("Logged in with Facebook: " + user.displayName);
    } catch(err) { alert(err.message); }
  }

  window.logout = async function() {
    await signOut(auth);
    location.reload();
  }

  // Global setupUser
  window.setupUser = function(user) {
    currentUser = user;
    authCard.style.display="none";
    postCard.style.display="block";
    logoutBtn.style.display="inline-block";
    userBox.innerHTML="Logged in as <b>"+(user.displayName || user.email)+"</b>";
    renderListings();
  }

  onAuthStateChanged(auth, user => { if(user) window.setupUser(user); });

  // Firestore setup
  const listingsCol = collection(db,"listings");
  let currentUser = null;

  window.addListing = async function() {
    const file = document.getElementById("image").files[0];
    let imgUrl = "";
    if(file){
      const storageRef = ref(storage,"images/"+file.name+Date.now());
      await uploadBytes(storageRef,file);
      imgUrl = await getDownloadURL(storageRef);
    }

    const data = {
      user: currentUser.email,
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      location: document.getElementById("location").value,
      price: document.getElementById("price").value,
      size: document.getElementById("size").value,
      img: imgUrl,
      boosted: false,
      createdAt: new Date()
    };
    await addDoc(listingsCol, data);
    renderListings();
  }

  window.boostListing = async function(id) {
    const docRef = doc(db,"listings",id);
    await updateDoc(docRef,{boosted:true});
    alert("Boosted! (M-PESA integration pending)");
    renderListings();
  }

  window.deleteListing = async function(id){
    if(confirm("Delete listing?")){
      await deleteDoc(doc(db,"listings",id));
      renderListings();
    }
  }

  window.renderListings = async function(){
    const searchText = document.getElementById("search").value.toLowerCase();
    const querySnap = await getDocs(query(listingsCol,orderBy("boosted","desc")));
    const container = document.getElementById("listings");
    container.innerHTML = "";
    querySnap.forEach(docSnap=>{
      const l = docSnap.data();
      const id = docSnap.id;
      if(!l.location.toLowerCase().includes(searchText)) return;
      container.innerHTML+=`
        <div class="listing">
          ${l.img?`<img src="${l.img}">`:""}
          <b>${l.name}</b><br>
          Size: ${l.size}<br>
          Price: KES ${l.price}<br>
          Location: ${l.location}<br>
          ${l.boosted?"‚≠ê Boosted<br>":""}
          <a href="https://wa.me/${l.phone}" target="_blank"><button>WhatsApp Seller</button></a>
          <a href="https://www.google.com/maps/search/?api=1&query=${l.location}" target="_blank"><button>Open Map</button></a>
          <button class="boost" onclick="boostListing('${id}')">Boost</button>
          ${l.user===currentUser.email?`<button onclick="deleteListing('${id}')">Delete</button>`:""}
        </div>
      `;
    });
  }
</script>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2;}
header{background:#0a7d36;color:white;text-align:center;padding:15px;}
.container{max-width:900px;margin:auto;padding:15px;}
.card{background:white;padding:15px;margin-bottom:15px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none;color:white;background:#0a7d36;cursor:pointer;}
button:hover{background:#095c29;}
.listing{border-top:1px solid #ddd;padding:12px 0;}
.boost{background:orange;}
img{width:100%;max-height:200px;object-fit:cover;border-radius:8px;}
.small{font-size:13px;color:#555;}
</style>
</head>

<body>

<header>
<h2>Gas Hub Marketplace</h2>
<div id="userBox"></div>
<button onclick="logout()" id="logoutBtn" style="display:none">Logout</button>
</header>

<div class="container">

<!-- AUTH -->
<div class="card" id="authCard">
<h3>Login / Signup</h3>
<button onclick="googleLogin()">Login with Google</button>
<button onclick="facebookLogin()">Login with Facebook</button>
</div>

<!-- POST LISTING -->
<div class="card" id="postCard" style="display:none">
<h3>Post Listing</h3>
<input id="name" placeholder="Seller Name">
<input id="phone" placeholder="WhatsApp Number (254...)">
<input id="location" placeholder="Location">
<input id="price" placeholder="Price (KES)">
<select id="size">
<option>6kg</option>
<option>13kg</option>
<option>50kg</option>
</select>
<input type="file" id="image">
<button onclick="addListing()">Post Listing</button>
</div>

<!-- SEARCH -->
<div class="card">
<h3>Search</h3>
<input id="search" placeholder="Search by location..." onkeyup="renderListings()">
</div>

<!-- LISTINGS -->
<div class="card">
<h3>Available Listings</h3>
<div id="listings"></div>
</div>

</body>
</html>
